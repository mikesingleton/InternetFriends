{"version":3,"sources":["scripts/chat.js"],"names":["User","id","submitCallback","submitInput","_inputElement","text","length","_this","say","_submitCallback","hideInput","is","setupInputElement","keydown","e","keyCode","preventDefault","keyup","repositionElements","_userElement","css","_mousePosition","y","x","_id","_speechElement","_mouseElement","_fadeoutTimer","_mouseFadeoutTimer","init","$","appendTo","Logger","log","cursorURL","chrome","extension","getURL","_mouseBGElm","background-image","focusInput","blur","focus","setMousePosition","removeClass","clearTimeout","setTimeout","addClass","message","html","Chat","onMessage","request","event","message_onScroll","data","message_onMousemove","message_onMouseleave","message_onEnterpressed","message_onUserchat","_portManager","tell","getUser","userId","_users","_scrollPosition","scrollX","scrollY","user","portManager","document","addEventListener"],"mappings":"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","file":"chat.js","sourcesContent":["\"use strict\";\n\nvar User = function User(id, submitCallback) {\n  // variables ----------------------------------------------------------------\n  var _this = {},\n      _id = null,\n      _mousePosition = {},\n      _userElement = null,\n      _speechElement = null,\n      _inputElement = null,\n      _mouseElement = null,\n      _fadeoutTimer = -1,\n      _mouseFadeoutTimer = -1,\n      _submitCallback = submitCallback; // initialize ---------------------------------------------------------------\n\n\n  _this.init = function (id) {\n    _id = id;\n    _mousePosition = {\n      x: 0,\n      y: 0\n    };\n    _userElement = $('<div id=\"' + id + '\" class=\"user\"></div>').appendTo($('body'));\n    _speechElement = $('<p class=\"speech fadeout\"></p>').appendTo(_userElement);\n    Logger.log(_id);\n\n    if (_id == \"localuser\") {\n      _inputElement = $('<span contenteditable=\"true\" class=\"input\"></span>').appendTo(_userElement);\n      setupInputElement();\n    } else {\n      var cursorURL = chrome && chrome.extension ? chrome.extension.getURL('../../images/aero_arrow.cur') : './images/aero_arrow.cur';\n      _mouseElement = $('<div class=\"fakeMouse\"></div>').appendTo(_userElement);\n      _mouseBGElm = $('<div class=\"fakeMouseBackgroundColor\"></div>').appendTo(_mouseElement);\n\n      _mouseBGElm.css({\n        'background-image': 'url(' + cursorURL + ')'\n      });\n    }\n  }; // private functions --------------------------------------------------------\n\n\n  function submitInput() {\n    if (_inputElement.text().length > 0) {\n      _this.say(_inputElement.text());\n\n      _submitCallback(_inputElement.text());\n\n      _inputElement.text('');\n    }\n  }\n\n  function hideInput() {\n    if (_inputElement.is(\":visible\")) {//_inputElement.addClass('hidden');\n    }\n  }\n\n  function setupInputElement() {\n    if (_inputElement) {\n      _inputElement.keydown(function (e) {\n        if (e.keyCode == 13) {\n          e.preventDefault();\n        } else if (_inputElement.text().length == 0 && e.keyCode == 8) {\n          hideInput();\n        }\n      });\n\n      _inputElement.keyup(function (e) {\n        if (e.keyCode == 13) {\n          submitInput();\n          e.preventDefault();\n        }\n      });\n    }\n  }\n\n  ;\n\n  function repositionElements() {\n    _userElement.css('top', _mousePosition.y + 'px');\n\n    _userElement.css('left', _mousePosition.x + 'px');\n  }\n\n  ; // public functions ---------------------------------------------------------\n\n  _this.focusInput = function () {\n    //_inputElement.removeClass('hidden');\n    if (_inputElement) {\n      _inputElement.blur();\n\n      _inputElement.focus();\n    }\n  };\n\n  _this.setMousePosition = function (x, y) {\n    _mousePosition.x = x;\n    _mousePosition.y = y;\n    repositionElements();\n\n    if (_mouseElement) {\n      _mouseElement.removeClass(\"fadeout\");\n\n      clearTimeout(_mouseFadeoutTimer);\n      _mouseFadeoutTimer = setTimeout(function () {\n        _mouseElement.addClass(\"fadeout\");\n      }, 5000);\n    }\n  };\n\n  _this.say = function (message) {\n    _speechElement.removeClass(\"fadeout\");\n\n    _speechElement.html(message);\n\n    clearTimeout(_fadeoutTimer);\n    _fadeoutTimer = setTimeout(function () {\n      _speechElement.addClass(\"fadeout\");\n    }, 2000);\n\n    if (_mouseElement) {\n      _mouseElement.removeClass(\"fadeout\");\n\n      clearTimeout(_mouseFadeoutTimer);\n      _mouseFadeoutTimer = setTimeout(function () {\n        _mouseElement.addClass(\"fadeout\");\n      }, 5000);\n    }\n  };\n\n  _this.init(id);\n\n  return _this;\n};\n\nLogger.log('init chat.js');\n\nvar Chat = function () {\n  // variables ----------------------------------------------------------------\n  var _this = {},\n      _portManager = null,\n      _users = {},\n      _scrollPosition = {}; // initialize ---------------------------------------------------------------\n\n  _this.init = function () {\n    Logger.log('init chat');\n    _portManager = new portManager(\"chat\", onMessage);\n    _scrollPosition = {\n      x: 0,\n      y: 0\n    };\n  }; // events -------------------------------------------------------------------\n\n\n  function onMessage(request) {\n    Logger.log('got chat message', request);\n\n    switch (request.event) {\n      case 'scroll':\n        message_onScroll(request.data);\n        break;\n\n      case 'mousemove':\n        message_onMousemove(request.data);\n        break;\n\n      case 'mouseleave':\n        message_onMouseleave(request.data);\n        break;\n\n      case 'enterpressed':\n        message_onEnterpressed(request.data);\n        break;\n\n      case 'userchat':\n        message_onUserchat(request.data);\n        break;\n    }\n  }\n\n  ; // private functions ---------------------------------------------------------\n\n  function submitInput(message) {\n    var data = {\n      message: message\n    };\n\n    _portManager.tell(\"userchat\", data);\n  }\n\n  ;\n\n  function getUser(userId) {\n    if (!_users[userId]) _users[userId] = new User(userId, submitInput);\n    return _users[userId];\n  }\n\n  ; // messages -----------------------------------------------------------------\n\n  function message_onScroll(data) {\n    _scrollPosition.x = data.scrollX;\n    _scrollPosition.y = data.scrollY;\n  }\n\n  function message_onMousemove(data) {\n    var user = getUser(data.userId);\n    var y = data.y - _scrollPosition.y;\n    var x = data.x - _scrollPosition.x;\n    user.setMousePosition(x, y);\n  }\n\n  ;\n\n  function message_onMouseleave(data) {}\n\n  ;\n\n  function message_onEnterpressed(data) {\n    var user = getUser(data.userId);\n    user.focusInput();\n    Logger.log('focus input');\n  }\n\n  ;\n\n  function message_onUserchat(data) {\n    var user = getUser(data.userId);\n    user.say(data.message);\n  }\n\n  ;\n  return _this;\n}();\n\ndocument.addEventListener(\"DOMContentLoaded\", function () {\n  new Chat.init();\n}, false);"]}